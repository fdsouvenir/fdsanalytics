#!/bin/bash
# Deploy MCP Server to Cloud Run

set -e

PROJECT_ID="fdsanalytics"
REGION="us-central1"
SERVICE_NAME="mcp-server"
IMAGE="gcr.io/${PROJECT_ID}/${SERVICE_NAME}:latest"

echo "üöÄ Deploying MCP Server to Cloud Run..."

# Navigate to service directory
cd "$(dirname "$0")/../services/mcp-server"

# Build Docker image
echo "üì¶ Building Docker image..."
docker build -t "${IMAGE}" .

# Push to Container Registry
echo "‚¨ÜÔ∏è  Pushing image to GCR..."
docker push "${IMAGE}"

# Deploy to Cloud Run
echo "üåê Deploying to Cloud Run..."
gcloud run deploy "${SERVICE_NAME}" \
  --image "${IMAGE}" \
  --region "${REGION}" \
  --platform managed \
  --allow-unauthenticated \
  --memory 512Mi \
  --cpu 1 \
  --timeout 60 \
  --max-instances 10 \
  --set-env-vars \
    PROJECT_ID="${PROJECT_ID}",\
    REGION="${REGION}",\
    BQ_DATASET_ANALYTICS="restaurant_analytics",\
    BQ_DATASET_INSIGHTS="insights",\
    DEFAULT_TIMEZONE="America/Chicago",\
    NODE_ENV="production" \
  --project "${PROJECT_ID}"

# Get service URL
SERVICE_URL=$(gcloud run services describe "${SERVICE_NAME}" \
  --region "${REGION}" \
  --format 'value(status.url)' \
  --project "${PROJECT_ID}")

echo "‚úÖ Deployment complete!"
echo "üìã Service URL: ${SERVICE_URL}"
echo ""
echo "Test endpoints:"
echo "  Health: ${SERVICE_URL}/health"
echo "  MCP: ${SERVICE_URL}/mcp"
